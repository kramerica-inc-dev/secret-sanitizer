<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secret Sanitizer</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#0a0a0a;color:#e0e0e0;height:100vh;display:flex;flex-direction:column}
header{background:#111;border-bottom:1px solid #222;padding:12px 24px;display:flex;align-items:center;justify-content:space-between}
header h1{font-size:18px;font-weight:600;color:#10b981}
header h1 span{color:#6b7280;font-weight:400;margin-left:8px;font-size:13px}
.header-actions{display:flex;gap:8px;align-items:center}
.btn{padding:6px 14px;border:1px solid #333;border-radius:6px;background:#1a1a1a;color:#ccc;cursor:pointer;font-size:13px;transition:all .15s}
.btn:hover{background:#252525;border-color:#444}
.btn-primary{background:#059669;border-color:#059669;color:#fff}
.btn-primary:hover{background:#047857}
.btn-danger{border-color:#7f1d1d;color:#f87171}
.btn-danger:hover{background:#1a0505}
main{flex:1;display:flex;overflow:hidden}
.panel{flex:1;display:flex;flex-direction:column;padding:16px;overflow:hidden}
.panel-left{border-right:1px solid #222}
.panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.panel-header h2{font-size:14px;color:#9ca3af;text-transform:uppercase;letter-spacing:.05em}
.input-tabs{display:flex;gap:0;margin-bottom:12px}
.input-tab{padding:8px 16px;font-size:13px;color:#6b7280;cursor:pointer;border:1px solid #222;background:#111;transition:all .15s}
.input-tab:first-child{border-radius:6px 0 0 6px}
.input-tab:last-child{border-radius:0 6px 6px 0}
.input-tab.active{background:#1a1a1a;color:#10b981;border-color:#059669}
.input-tab:hover:not(.active){background:#1a1a1a;color:#9ca3af}
.scan-depth{display:flex;gap:0;margin-bottom:12px}
.depth-btn{padding:6px 12px;font-size:12px;color:#6b7280;cursor:pointer;border:1px solid #222;background:#111;transition:all .15s}
.depth-btn:first-child{border-radius:6px 0 0 6px}
.depth-btn:last-child{border-radius:0 6px 6px 0}
.depth-btn:hover:not(.active){background:#1a1a1a;color:#9ca3af}
.depth-btn.active[data-depth="quick"]{background:#065f46;color:#6ee7b7;border-color:#059669}
.depth-btn.active[data-depth="standard"]{background:#1e3a5f;color:#93c5fd;border-color:#3b82f6}
.depth-btn.active[data-depth="deep"]{background:#581c87;color:#d8b4fe;border-color:#8b5cf6}
textarea{flex:1;width:100%;background:#111;border:1px solid #222;border-radius:8px;padding:16px;color:#e0e0e0;font-family:"SF Mono",Monaco,"Cascadia Code",monospace;font-size:13px;line-height:1.6;resize:none;outline:none;transition:border-color .15s}
textarea:focus{border-color:#059669}
textarea::placeholder{color:#4b5563}
.output-area{flex:1;background:#111;border:1px solid #222;border-radius:8px;padding:16px;font-family:"SF Mono",Monaco,"Cascadia Code",monospace;font-size:13px;line-height:1.6;overflow-y:auto;white-space:pre-wrap;word-break:break-all;position:relative}
.output-placeholder{color:#4b5563;position:absolute;top:16px;left:16px}
.drop-zone{flex:1;border:2px dashed #333;border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;cursor:pointer;transition:all .2s;position:relative}
.drop-zone:hover,.drop-zone.dragover{border-color:#059669;background:rgba(5,150,105,.05)}
.drop-zone.dragover{background:rgba(5,150,105,.1)}
.drop-zone-icon{font-size:40px;opacity:.6}
.drop-zone-text{color:#6b7280;font-size:14px;text-align:center}
.drop-zone-text strong{color:#9ca3af;display:block;margin-bottom:4px}
.drop-zone-hint{color:#4b5563;font-size:12px}
.drop-zone input[type="file"]{position:absolute;inset:0;opacity:0;cursor:pointer}
.file-info{background:#111;border:1px solid #222;border-radius:8px;padding:16px;display:flex;align-items:center;gap:12px}
.file-info-icon{font-size:28px}
.file-info-details{flex:1}
.file-info-name{font-size:14px;color:#e0e0e0;font-weight:500}
.file-info-meta{font-size:12px;color:#6b7280;margin-top:2px}
.file-info .btn{flex-shrink:0}
.status-bar{background:#111;border-top:1px solid #222;padding:8px 24px;font-size:12px;color:#6b7280;display:flex;justify-content:space-between}
.findings-badge{background:#7f1d1d;color:#f87171;padding:2px 8px;border-radius:10px;font-size:12px;font-weight:600;margin-left:8px}
.findings-badge.clean{background:#052e16;color:#10b981}
.extraction-banner{background:#172554;border:1px solid #1e3a5f;color:#93c5fd;padding:8px 12px;border-radius:6px;font-size:12px;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.layer-badges{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
.layer-badge{font-size:11px;padding:2px 8px;border-radius:8px;font-weight:500}
.layer-badge.gitleaks{background:#052e16;color:#6ee7b7}
.layer-badge.presidio{background:#172554;color:#93c5fd}
.layer-badge.deduce{background:#3b0764;color:#d8b4fe}
.layer-badge.crossReference{background:#4a1d6a;color:#c084fc}
.layer-badge.error{background:#7f1d1d;color:#fca5a5}
.findings-panel{max-height:140px;overflow-y:auto;margin-bottom:8px;border:1px solid #222;border-radius:6px}
.finding-row{font-size:12px;padding:4px 8px;border-bottom:1px solid #1a1a1a;display:flex;align-items:center;gap:6px;color:#9ca3af}
.finding-row:last-child{border-bottom:none}
.finding-src{font-size:10px;text-transform:uppercase;font-weight:700;padding:1px 5px;border-radius:4px}
.finding-src.gitleaks{background:#052e16;color:#6ee7b7}
.finding-src.presidio{background:#172554;color:#93c5fd}
.finding-src.deduce{background:#3b0764;color:#d8b4fe}
.finding-src.cross-reference{background:#4a1d6a;color:#c084fc}
.finding-type{color:#6b7280;min-width:100px}
.finding-text{color:#e0e0e0;font-family:"SF Mono",monospace;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.finding-reason{font-size:10px;color:#6b7280;font-style:italic}
.history-drawer{position:fixed;right:-400px;top:0;bottom:0;width:400px;background:#111;border-left:1px solid #222;transition:right .3s;z-index:100;display:flex;flex-direction:column}
.history-drawer.open{right:0}
.history-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99;display:none}
.history-overlay.open{display:block}
.history-header{padding:16px;border-bottom:1px solid #222;display:flex;justify-content:space-between;align-items:center}
.history-header h2{font-size:16px}
.history-list{flex:1;overflow-y:auto;padding:8px}
.history-item{padding:12px;border:1px solid #222;border-radius:6px;margin-bottom:8px;cursor:pointer;transition:background .15s}
.history-item:hover{background:#1a1a1a}
.history-item .time{font-size:11px;color:#6b7280}
.history-item .preview{font-size:12px;color:#9ca3af;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.history-item .badge{font-size:11px;padding:1px 6px;border-radius:8px;margin-left:6px}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#059669;color:#fff;padding:8px 20px;border-radius:6px;font-size:13px;opacity:0;transition:opacity .3s;z-index:200;pointer-events:none}
.toast.show{opacity:1}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid #333;border-top-color:#10b981;border-radius:50%;animation:spin .6s linear infinite;margin-right:6px;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}
.btn-delete{background:none;border:none;cursor:pointer;float:right;font-size:14px;opacity:.4;padding:2px 4px;border-radius:4px}.btn-delete:hover{opacity:1;background:#1a0505}
.hidden{display:none!important}
.privacy-link{color:#6b7280;cursor:pointer;text-decoration:underline;text-decoration-style:dotted;text-underline-offset:2px}
.privacy-link:hover{color:#9ca3af}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:300;display:none;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:#1a1a1a;border:1px solid #333;border-radius:12px;max-width:560px;width:90%;max-height:80vh;overflow-y:auto;padding:24px}
.modal h2{font-size:16px;color:#10b981;margin-bottom:16px}
.modal h3{font-size:13px;color:#9ca3af;margin-top:16px;margin-bottom:8px;text-transform:uppercase;letter-spacing:.05em}
.modal p,.modal li{font-size:13px;color:#ccc;line-height:1.7}
.modal ul{padding-left:20px;margin-bottom:12px}
.modal li{margin-bottom:4px}
.modal-close{float:right;background:none;border:none;color:#6b7280;font-size:18px;cursor:pointer;padding:4px 8px}
.modal-close:hover{color:#e0e0e0}
@media(max-width:768px){main{flex-direction:column}.panel-left{border-right:none;border-bottom:1px solid #222}.history-drawer{width:100%;right:-100%}}
</style>
</head>
<body>
<header>
<h1>&#x1f510; Secret Sanitizer<span>Paste &rarr; Detect &rarr; Clean</span></h1>
<div class="header-actions">
<button class="btn" onclick="toggleHistory()">&#x1f4cb; History</button>
<button class="btn btn-danger" onclick="clearAll()">Clear</button>
</div>
</header>
<main>
<div class="panel panel-left">
<div class="panel-header"><h2>Input</h2><span id="charCount" style="font-size:12px;color:#6b7280">0 chars</span></div>
<div class="input-tabs">
<div class="input-tab active" onclick="switchTab('text')">&#x1f4dd; Paste text</div>
<div class="input-tab" onclick="switchTab('file')">&#x1f4c1; Upload file</div>
</div>
<div class="scan-depth">
<div class="depth-btn active" data-depth="quick" onclick="setDepth('quick')" title="Gitleaks only &#8212; credentials, tokens, API keys">&#x26a1; Quick</div>
<div class="depth-btn" data-depth="standard" onclick="setDepth('standard')" title="+ Presidio &#8212; IBAN, BSN, email, phone, IP">&#x1f50d; Standard</div>
<div class="depth-btn" data-depth="deep" onclick="setDepth('deep')" title="+ Deduce + cross-reference &#8212; Dutch names, organizations, locations">&#x1f52c; Deep</div>
</div>
<textarea id="input" placeholder="Paste your code, config, logs, or any text here...&#10;&#10;Use the scan depth selector:&#10;  &#x26a1; Quick &#8212; credentials only (Gitleaks)&#10;  &#x1f50d; Standard &#8212; + PII detection (Presidio)&#10;  &#x1f52c; Deep &#8212; + Dutch names &amp; orgs (Deduce) + cross-reference"></textarea>
<div id="dropZoneContainer" class="hidden" style="flex:1;display:flex;flex-direction:column;gap:12px">
<div class="drop-zone" id="dropZone">
<input type="file" id="fileInput" accept=".json,.yaml,.yml,.toml,.env,.sh,.bash,.log,.txt,.md,.xml,.csv,.ini,.cfg,.conf,.properties,.py,.js,.ts,.html,.css,.pdf,.docx">
<div class="drop-zone-icon">&#x1f4c4;</div>
<div class="drop-zone-text">
<strong>Drop file here or click to browse</strong>
Supports text files, .json, .yaml, .toml, .env, .sh, .log, .md, .pdf, .docx and more
</div>
<div class="drop-zone-hint">Max file size: 50MB &bull; PDF and Word files: text will be extracted first</div>
</div>
<div id="fileInfo" class="file-info hidden">
<span class="file-info-icon" id="fileIcon">&#x1f4c4;</span>
<div class="file-info-details">
<div class="file-info-name" id="fileName"></div>
<div class="file-info-meta" id="fileMeta"></div>
</div>
<button class="btn btn-danger" onclick="removeFile()">&#x2715; Remove</button>
</div>
</div>
</div>
<div class="panel">
<div class="panel-header">
<h2>Sanitized Output<span id="findingsBadge"></span></h2>
<div style="display:flex;gap:8px">
<button class="btn btn-primary" onclick="sanitize()">&#x1f6e1; Sanitize</button>
<button class="btn" onclick="copyOutput()">&#x1f4cb; Copy</button>
</div>
</div>
<div id="layerBadges" class="layer-badges hidden"></div>
<div id="findingsPanel" class="findings-panel hidden"></div>
<div class="output-area" id="output"><span class="output-placeholder" id="outputPlaceholder">Sanitized output will appear here...</span></div>
</div>
</main>
<div class="status-bar"><span id="status">Ready</span><span style="display:flex;gap:16px;align-items:center"><span class="privacy-link" onclick="togglePrivacy()">&#x1f512; Privacy</span><span id="lastRun"></span></span></div>
<div class="history-overlay" id="historyOverlay" onclick="toggleHistory()"></div>
<div class="history-drawer" id="historyDrawer">
<div class="history-header"><h2>History</h2><button class="btn" onclick="toggleHistory()">&#x2715;</button></div>
<div class="history-list" id="historyList"></div>
</div>
<div class="toast" id="toast"></div>
<div class="modal-overlay" id="privacyOverlay" onclick="if(event.target===this)togglePrivacy()">
<div class="modal">
<button class="modal-close" onclick="togglePrivacy()">&#x2715;</button>
<h2>&#x1f512; Privacy &amp; Data Protection</h2>
<p>Secret Sanitizer is designed with <strong>data minimization</strong> as its core principle. Your data is processed, not stored.</p>
<h3>How your data is processed</h3>
<ul>
<li><strong>Local processing:</strong> All scans run on the server — nothing is sent to external services</li>
<li><strong>No storage:</strong> Text and files are wiped from memory immediately after processing (memory wipe)</li>
<li><strong>Temp files:</strong> Temporary files are deleted after each scan and automatically cleaned up by the system</li>
<li><strong>No content logging:</strong> Logs contain only metadata (timing, counts, file type) — never the content of your text or files</li>
<li><strong>Console filtering:</strong> PII patterns (BSN, IBAN, phone numbers) are automatically filtered from all log output</li>
</ul>
<h3>What is retained</h3>
<ul>
<li><strong>Scan history:</strong> Stored in your browser (localStorage), not on the server. Expires automatically after 24 hours. You can clear it anytime via the History button.</li>
<li><strong>Audit logs:</strong> Metadata only — timestamp, scan depth, findings count, file type and size. Automatically deleted after 48 hours.</li>
</ul>
<h3>Security</h3>
<ul>
<li>HTTPS encryption (SSL/TLS)</li>
<li>Two-factor authentication (Authelia 2FA)</li>
<li>Rate limiting on all API endpoints</li>
<li>Core dumps disabled</li>
<li>Security headers via Helmet</li>
</ul>
<p style="margin-top:16px;color:#6b7280;font-size:12px">Secret Sanitizer v1.1.0 &bull; No external services &bull; No tracking &bull; No cookies</p>
</div>
</div>
<script>
const HISTORY_KEY="ss_history",MAX_HISTORY=50,TTL=86400000;
let history=loadHistory(), currentTab="text", selectedFile=null, scanDepth="quick";
const BINARY_EXTENSIONS=[".pdf",".docx"];

function loadHistory(){try{const h=JSON.parse(localStorage.getItem(HISTORY_KEY)||"[]");return h.filter(i=>Date.now()-i.ts<TTL)}catch(e){return[]}}
function saveHistory(){localStorage.setItem(HISTORY_KEY,JSON.stringify(history.slice(0,MAX_HISTORY)))}

function setDepth(d){
  scanDepth=d;
  document.querySelectorAll(".depth-btn").forEach(b=>b.classList.toggle("active",b.dataset.depth===d));
}

function switchTab(tab){
  currentTab=tab;
  document.querySelectorAll(".input-tab").forEach((t,i)=>t.classList.toggle("active",i===(tab==="text"?0:1)));
  document.getElementById("input").classList.toggle("hidden",tab==="file");
  document.getElementById("dropZoneContainer").classList.toggle("hidden",tab==="text");
  document.getElementById("charCount").textContent=tab==="text"?document.getElementById("input").value.length+" chars":(selectedFile?formatSize(selectedFile.size):"No file");
}

function formatSize(b){if(b<1024)return b+" B";if(b<1048576)return(b/1024).toFixed(1)+" KB";return(b/1048576).toFixed(1)+" MB"}
function getFileExt(n){var d=n.lastIndexOf(".");return d>=0?n.substring(d).toLowerCase():""}
function getFileIcon(n){var e=getFileExt(n);return e===".pdf"?"\ud83d\udcd5":e===".docx"?"\ud83d\udcd8":"\ud83d\udcc4"}
function isBinaryFile(n){return BINARY_EXTENSIONS.includes(getFileExt(n))}

var dropZone=document.getElementById("dropZone"),fileInput=document.getElementById("fileInput");
["dragenter","dragover"].forEach(function(e){dropZone.addEventListener(e,function(ev){ev.preventDefault();ev.stopPropagation();dropZone.classList.add("dragover")})});
["dragleave","drop"].forEach(function(e){dropZone.addEventListener(e,function(ev){ev.preventDefault();ev.stopPropagation();dropZone.classList.remove("dragover")})});
dropZone.addEventListener("drop",function(ev){if(ev.dataTransfer.files.length>0)handleFile(ev.dataTransfer.files[0])});
fileInput.addEventListener("change",function(ev){if(ev.target.files.length>0)handleFile(ev.target.files[0])});
document.body.addEventListener("dragenter",function(ev){if(ev.dataTransfer.types.includes("Files")&&currentTab==="text")switchTab("file")});

function handleFile(file){
  if(file.size>50*1024*1024){showToast("File too large (max 50MB)");return}
  selectedFile=file;
  document.getElementById("dropZone").classList.add("hidden");
  document.getElementById("fileInfo").classList.remove("hidden");
  document.getElementById("fileIcon").textContent=getFileIcon(file.name);
  document.getElementById("fileName").textContent=file.name;
  var meta=formatSize(file.size)+" \u2022 "+(file.type||"text/plain");
  if(isBinaryFile(file.name))meta+=" \u2022 Text will be extracted";
  document.getElementById("fileMeta").textContent=meta;
  document.getElementById("charCount").textContent=formatSize(file.size);
}

function removeFile(){
  selectedFile=null;fileInput.value="";
  document.getElementById("dropZone").classList.remove("hidden");
  document.getElementById("fileInfo").classList.add("hidden");
  document.getElementById("charCount").textContent="No file";
}

async function sanitize(){
  var status=document.getElementById("status");
  var depthLabel=scanDepth==="deep"?"Deep scanning (3 layers + cross-ref)...":scanDepth==="standard"?"Scanning (2 layers)...":"Scanning...";

  if(currentTab==="file"){
    if(!selectedFile){showToast("No file selected");return}
    var label=isBinaryFile(selectedFile.name)?"Extracting text & "+depthLabel.toLowerCase():depthLabel;
    status.innerHTML='<span class="spinner"></span>'+label;
    try{
      var formData=new FormData();
      formData.append("file",selectedFile);
      formData.append("depth",scanDepth);
      var res=await fetch("/api/sanitize-file",{method:"POST",body:formData});
      var data=await res.json();
      if(!res.ok)throw new Error(data.error||"Server error");
      showResult(data,selectedFile.name+" ("+formatSize(selectedFile.size)+")");
    }catch(e){status.textContent="Error: "+e.message;showToast("Error: "+e.message)}
    return;
  }

  var input=document.getElementById("input").value.trim();
  if(!input){showToast("Nothing to sanitize");return}
  status.innerHTML='<span class="spinner"></span>'+depthLabel;
  try{
    var res=await fetch("/api/sanitize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:input,depth:scanDepth})});
    var data=await res.json();
    if(!res.ok)throw new Error(data.error||"Server error");
    showResult(data,input.substring(0,80));
  }catch(e){status.textContent="Error: "+e.message;showToast("Error: "+e.message)}
}

function showResult(data,previewText){
  var ph=document.getElementById("outputPlaceholder");if(ph)ph.style.display="none";
  var outputEl=document.getElementById("output");
  outputEl.textContent="";

  if(data.extracted){
    var banner=document.createElement("div");
    banner.className="extraction-banner";
    banner.textContent="\u2139\uFE0F Text extracted from "+data.sourceType+" document ("+data.extractedLength.toLocaleString()+" characters)";
    outputEl.appendChild(banner);
  }

  outputEl.appendChild(document.createTextNode(data.sanitized));

  var count=data.count||0;
  var badge=document.getElementById("findingsBadge");
  badge.innerHTML=count>0?'<span class="findings-badge">'+count+" finding"+(count>1?"s":"")+" redacted</span>":'<span class="findings-badge clean">Clean \u2713</span>';

  // Layer badges
  var lb=document.getElementById("layerBadges");
  if(data.layers){
    lb.classList.remove("hidden");
    lb.innerHTML="";
    var layerNames={gitleaks:"Gitleaks",presidio:"Presidio",deduce:"Deduce",crossReference:"Cross-ref"};
    for(var key in data.layers){
      var val=data.layers[key];
      var span=document.createElement("span");
      if(typeof val==="number"){
        span.className="layer-badge "+key;
        span.textContent=layerNames[key]+": "+val;
      }else{
        span.className="layer-badge error";
        span.textContent=(layerNames[key]||key)+": error";
      }
      lb.appendChild(span);
    }
  }else{lb.classList.add("hidden")}

  // Findings panel
  var fp=document.getElementById("findingsPanel");
  if(data.findings&&data.findings.length>0){
    fp.classList.remove("hidden");
    fp.innerHTML="";
    data.findings.forEach(function(f){
      var row=document.createElement("div");
      row.className="finding-row";
      var src=document.createElement("span");
      src.className="finding-src "+f.source;
      src.textContent=f.source==="cross-reference"?"x-ref":f.source;
      var type=document.createElement("span");
      type.className="finding-type";
      type.textContent=f.rule;
      var txt=document.createElement("span");
      txt.className="finding-text";
      txt.textContent=f.text.length>60?f.text.substring(0,60)+"...":f.text;
      row.appendChild(src);row.appendChild(type);row.appendChild(txt);
      if(f.reason){
        var reason=document.createElement("span");
        reason.className="finding-reason";
        reason.textContent=f.reason==="value-propagation"?"propagated":f.reason==="email-extraction"?"from email":"";
        if(reason.textContent)row.appendChild(reason);
      }
      fp.appendChild(row);
    });
  }else{fp.classList.add("hidden")}

  var st="Scan complete ("+data.depth+")";
  if(data.filename)st+=" \u2022 "+data.filename;
  if(data.extracted)st+=" ("+data.sourceType+" extracted)";
  document.getElementById("status").textContent=st;
  document.getElementById("lastRun").textContent="Last run: "+new Date().toLocaleTimeString();

  var inputText=currentTab==="text"?document.getElementById("input").value:("[File] "+data.filename);
  history.unshift({ts:Date.now(),preview:previewText,findings:count,depth:data.depth,input:inputText,output:data.sanitized,extracted:data.extracted||false,sourceType:data.sourceType||null});
  saveHistory();
}

function copyOutput(){
  var outputEl=document.getElementById("output");
  var cph=document.getElementById("outputPlaceholder");
  if(cph&&cph.style.display!=="none"){showToast("Nothing to copy");return}
  var text="";
  outputEl.childNodes.forEach(function(node){if(node.nodeType===Node.TEXT_NODE)text+=node.textContent});
  if(!text){showToast("Nothing to copy");return}
  navigator.clipboard.writeText(text).then(function(){showToast("Copied to clipboard!")}).catch(function(){showToast("Copy failed")});
}

function clearAll(){
  document.getElementById("input").value="";
  document.getElementById("output").innerHTML='<span class="output-placeholder" id="outputPlaceholder">Sanitized output will appear here...</span>';
  document.getElementById("findingsBadge").innerHTML="";
  document.getElementById("layerBadges").classList.add("hidden");
  document.getElementById("findingsPanel").classList.add("hidden");
  document.getElementById("status").textContent="Ready";
  document.getElementById("charCount").textContent=currentTab==="text"?"0 chars":"No file";
  removeFile();
}

function toggleHistory(){
  document.getElementById("historyDrawer").classList.toggle("open");
  document.getElementById("historyOverlay").classList.toggle("open");
  renderHistory();
}

function togglePrivacy(){
  document.getElementById("privacyOverlay").classList.toggle("open");
}

function renderHistory(){
  var list=document.getElementById("historyList");
  history=loadHistory();
  if(!history.length){list.innerHTML='<p style="color:#6b7280;padding:16px;text-align:center">No history yet</p>';return}
  list.innerHTML=history.map(function(h,i){
    var extra=h.extracted?'<span style="font-size:10px;color:#93c5fd;margin-left:4px">'+h.sourceType+'</span>':"";
    var depthTag=h.depth?'<span style="font-size:10px;color:#6b7280;margin-left:4px">'+h.depth+'</span>':"";
    return '<div class="history-item" onclick="restoreHistory('+i+')"><button class="btn-delete" onclick="event.stopPropagation();deleteHistory('+i+')">&#x1f5d1;</button><span class="time">'+new Date(h.ts).toLocaleString()+'</span><span class="badge '+(h.findings>0?"findings-badge":"findings-badge clean")+'">'+(h.findings>0?h.findings+" found":"Clean")+'</span>'+depthTag+extra+'<div class="preview">'+escHtml(h.preview)+"</div></div>";
  }).join("");
}

function restoreHistory(i){
  var h=history[i];if(!h)return;
  if(h.input.startsWith("[File] "))switchTab("text");
  document.getElementById("input").value=h.input;
  var ph=document.getElementById("outputPlaceholder");if(ph)ph.style.display="none";
  document.getElementById("output").textContent=h.output;
  var badge=document.getElementById("findingsBadge");
  badge.innerHTML=h.findings>0?'<span class="findings-badge">'+h.findings+" finding"+(h.findings>1?"s":"")+'</span>':'<span class="findings-badge clean">Clean \u2713</span>';
  document.getElementById("layerBadges").classList.add("hidden");
  document.getElementById("findingsPanel").classList.add("hidden");
  toggleHistory();showToast("Restored from history");
}

function deleteHistory(i){history.splice(i,1);saveHistory();renderHistory();showToast("Removed from history")}
function escHtml(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}
function showToast(msg){var t=document.getElementById("toast");t.textContent=msg;t.classList.add("show");setTimeout(function(){t.classList.remove("show")},2000)}
document.getElementById("input").addEventListener("input",function(){document.getElementById("charCount").textContent=this.value.length+" chars"});
document.getElementById("input").addEventListener("keydown",function(e){if((e.ctrlKey||e.metaKey)&&e.key==="Enter")sanitize()});
</script>
</body>
</html>
